<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Super Reader 2.0</title>

		<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
		<script src="mammoth.browser.min.js"></script>
		<script src="pdf.min.js"></script>
		<script>
			pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.min.js'
		</script>

		<style>
			:root {
				--outer-bg: #e0e0e0;
				--bg-color: #ffffff;
				--text-color: #000000;
				--font-family: 'Times New Roman';
				--font-size: 18px;
				--line-height: 1.5;
				--p-spacing: 1em;
				--content-width: 800px; /* –¢–µ–ø–µ—Ä—å —ç—Ç–æ max-width */
			}

			body {
				margin: 0;
				padding: 0;
				background-color: #222;
				font-family: sans-serif;
				height: 100vh;
				display: flex;
				flex-direction: column;
				overflow: hidden;
			}

			/* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–Ω—é */
			#toggle-toolbar-btn {
				position: fixed;
				top: 10px;
				right: 10px;
				z-index: 1001;
				background: rgba(0, 0, 0, 0.5);
				color: white;
				border: none;
				border-radius: 50%;
				width: 40px;
				height: 40px;
				cursor: pointer;
				font-size: 20px;
				display: flex;
				align-items: center;
				justify-content: center;
				transition: background 0.3s;
			}
			#toggle-toolbar-btn:hover {
				background: rgba(0, 0, 0, 0.8);
			}

			/* –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
			#toolbar {
				background: #2b2b2b;
				color: white;
				padding: 10px 60px 10px 20px; /* –û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ */
				display: flex;
				flex-wrap: wrap;
				gap: 15px;
				align-items: center;
				z-index: 100;
				border-bottom: 1px solid #444;
				flex-shrink: 0;
				transition: transform 0.3s ease, opacity 0.3s ease;
				max-height: 300px; /* –î–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
				opacity: 1;
			}

			/* –ö–ª–∞—Å—Å –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —Ç—É–ª–±–∞—Ä–∞ */
			#toolbar.hidden {
				transform: translateY(-100%);
				position: absolute;
				width: 100%;
				opacity: 0;
				pointer-events: none;
			}

			.control-group {
				display: flex;
				flex-direction: column;
				gap: 2px;
			}
			.control-row {
				display: flex;
				align-items: center;
				gap: 8px;
			}

			label {
				font-size: 10px;
				text-transform: uppercase;
				color: #888;
				letter-spacing: 1px;
				font-weight: bold;
			}

			select,
			input[type='number'] {
				padding: 5px;
				border-radius: 4px;
				border: 1px solid #555;
				background: #444;
				color: white;
			}

			/* –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏–Ω–ø—É—Ç—ã —Ü–≤–µ—Ç–∞ */
			input[type='color'] {
				border: none;
				width: 30px;
				height: 30px;
				padding: 0;
				background: none;
				cursor: pointer;
			}

			/* –°–ª–∞–π–¥–µ—Ä */
			input[type='range'] {
				cursor: pointer;
			}

			button.action-btn {
				cursor: pointer;
				padding: 6px 12px;
				background: #007bff;
				color: white;
				border: none;
				border-radius: 4px;
				transition: 0.2s;
			}
			button.action-btn:hover {
				background: #0056b3;
			}

			.theme-btn {
				width: 24px;
				height: 24px;
				border-radius: 50%;
				border: 2px solid #555;
				cursor: pointer;
				transition: transform 0.1s;
			}
			.theme-btn:hover {
				transform: scale(1.1);
				border-color: #fff;
			}

			/* –û–±–ª–∞—Å—Ç—å —á—Ç–µ–Ω–∏—è */
			#reader-container {
				flex: 1;
				overflow-y: auto;
				display: flex;
				background-color: var(--outer-bg);
				padding: 0;
				scroll-behavior: smooth;
				transition: background-color 0.3s ease;
				position: relative;
			}

			#content-wrapper {
				background-color: var(--bg-color);
				color: var(--text-color);
				width: 100%;
				max-width: var(--content-width);
				min-height: 100%;
				box-sizing: border-box;
				margin: 0 auto;
				padding: 50px;
				box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
				transition: background-color 0.3s ease, color 0.3s ease,
					max-width 0.3s ease;
			}

			#content-area {
				font-family: var(--font-family);
				font-size: var(--font-size);
				line-height: var(--line-height);
			}
			#content-area p {
				margin-bottom: var(--p-spacing);
				text-align: justify;
			}
			#content-area img {
				max-width: 100%;
				height: auto;
				display: block;
				margin: 20px auto;
			}

			canvas.pdf-page {
				margin-bottom: 0;
				display: block;
				width: 100%;
			}

			#pagination-controls {
				display: none;
				padding: 10px;
				background: #2b2b2b;
				color: white;
				justify-content: center;
				gap: 20px;
				flex-shrink: 0;
			}

			/* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
			@media (max-width: 600px) {
				#content-wrapper {
					padding: 20px;
				}
				#toolbar {
					padding-right: 50px;
					gap: 10px;
				}
				.control-group {
					min-width: 45%;
				}
			}
		</style>
	</head>
	<body>
		<!-- –ù–µ–≤–∏–¥–∏–º—ã–π –±–ª–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ -->
		<svg style="display: none">
			<defs>
				<filter id="recolor-filter">
					<!-- –°–Ω–∞—á–∞–ª–∞ –æ–±–µ—Å—Ü–≤–µ—á–∏–≤–∞–µ–º (–¥–µ–ª–∞–µ–º –ß–ë), —á—Ç–æ–±—ã —Ü–≤–µ—Ç–Ω—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ –º–µ—à–∞–ª–∏ -->
					<feColorMatrix
						type="matrix"
						values="0.33 0.33 0.33 0 0
                                                     0.33 0.33 0.33 0 0
                                                     0.33 0.33 0.33 0 0
                                                     0 0 0 1 0"
					/>

					<!-- –¢–µ–ø–µ—Ä—å –º–∞–ø–∏–º —è—Ä–∫–æ—Å—Ç—å –Ω–∞ –Ω–∞—à–∏ —Ü–≤–µ—Ç–∞ -->
					<feComponentTransfer>
						<feFuncR id="func-r" type="table" tableValues="0 1" />
						<feFuncG id="func-g" type="table" tableValues="0 1" />
						<feFuncB id="func-b" type="table" tableValues="0 1" />
					</feComponentTransfer>
				</filter>
			</defs>
		</svg>

		<!-- –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é -->
		<button id="toggle-toolbar-btn" onclick="toggleToolbar()">‚öôÔ∏è</button>

		<!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
		<div id="toolbar">
			<!-- 1. –§–∞–π–ª -->
			<div class="control-group">
				<label>–§–∞–π–ª</label>
				<input
					type="file"
					id="file-input"
					accept=".txt,.docx,.pdf"
					style="color: transparent; width: 90px"
				/>
			</div>

			<!-- 2. –¢–µ–º—ã (–ø—Ä–µ—Å–µ—Ç—ã) -->
			<div class="control-group">
				<label>–¢–µ–º—ã</label>
				<div class="control-row">
					<div
						class="theme-btn"
						style="background: #fff"
						onclick="setTheme('white')"
						title="–ë–µ–ª–∞—è"
					></div>
					<div
						class="theme-btn"
						style="background: #1a1a1a"
						onclick="setTheme('dark')"
						title="–¢–µ–º–Ω–∞—è"
					></div>
					<div
						class="theme-btn"
						style="background: #f4ecd8"
						onclick="setTheme('sepia')"
						title="–°–µ–ø–∏—è"
					></div>
				</div>
			</div>

			<!-- 3. –°–≤–æ—è —Ç–µ–º–∞ (Custom) -->
			<div class="control-group">
				<label>–°–≤–æ–π —Ü–≤–µ—Ç</label>
				<div class="control-row">
					<input
						type="color"
						id="custom-bg-picker"
						value="#ffffff"
						title="–§–æ–Ω"
					/>
					<input
						type="color"
						id="custom-text-picker"
						value="#000000"
						title="–¢–µ–∫—Å—Ç"
					/>
				</div>
			</div>

			<!-- 4. –®—Ä–∏—Ñ—Ç -->
			<div class="control-group">
				<label>–®—Ä–∏—Ñ—Ç</label>
				<div class="control-row">
					<select id="font-family">
						<option value="'Times New Roman', serif">Times</option>
						<option value="'Verdana', sans-serif">Verdana</option>
						<option value="'Arial', sans-serif">Arial</option>
						<option value="'Georgia', serif">Georgia</option>
						<option value="'Courier New', monospace">Courier</option>
					</select>
					<input
						type="number"
						id="font-size"
						value="18"
						min="10"
						max="50"
						style="width: 40px"
					/>
				</div>
			</div>

			<!-- 5. –®–∏—Ä–∏–Ω–∞ (–°–ª–∞–π–¥–µ—Ä) -->
			<div class="control-group" style="flex-grow: 1; max-width: 200px">
				<label>–®–∏—Ä–∏–Ω–∞: <span id="width-val">800px</span></label>
				<input
					type="range"
					id="width-slider"
					min="30"
					max="100"
					value="60"
					step="1"
					style="width: 100%"
				/>
			</div>

			<!-- 6. –ò–Ω—Ç–µ—Ä–≤–∞–ª -->
			<div class="control-group">
				<label>–°—Ç—Ä–æ–∫–∏</label>
				<input
					type="number"
					id="line-height"
					value="1.5"
					step="0.1"
					min="1"
					max="3"
					style="width: 40px"
				/>
			</div>

			<!-- 7. –ü–æ–¥–µ–ª–∏—Ç—å—Å—è -->
			<div class="control-group" style="margin-left: auto">
				<button class="action-btn" onclick="shareSettings()">üîó Share</button>
			</div>
		</div>

		<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
		<div id="reader-container">
			<div id="content-wrapper">
				<div id="content-area">
					<h1>Super Reader 2.0</h1>
					<p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª (.txt, .docx, .pdf), —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á—Ç–µ–Ω–∏–µ.</p>
					<p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ ‚öôÔ∏è –≤ —É–≥–ª—É, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</p>
					<p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞–ª–∏—Ç—Ä—É —Ü–≤–µ—Ç–æ–≤, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ—é —Ç–µ–º—É.</p>
				</div>
			</div>
		</div>

		<div id="pagination-controls">
			<button class="action-btn" id="prev-page">‚Üê</button>
			<span id="page-info">1-5</span>
			<button class="action-btn" id="next-page">‚Üí</button>
		</div>

		<script>
			// --- State ---
			const settings = {
				theme: 'white', // 'white', 'dark', 'sepia', 'custom'
				customBg: '#ffffff',
				customText: '#000000',
				fontFamily: "'Times New Roman', serif",
				fontSize: 18,
				lineHeight: 1.5,
				widthPercent: 60, // –í –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç 30 –¥–æ 100
			}

			// --- Elements ---
			const els = {
				toolbar: document.getElementById('toolbar'),
				wrapper: document.getElementById('content-wrapper'),
				fontSelect: document.getElementById('font-family'),
				sizeInput: document.getElementById('font-size'),
				widthSlider: document.getElementById('width-slider'),
				widthValDisplay: document.getElementById('width-val'),
				lhInput: document.getElementById('line-height'),
				bgPicker: document.getElementById('custom-bg-picker'),
				textPicker: document.getElementById('custom-text-picker'),
				fileInput: document.getElementById('file-input'),
				pagination: document.getElementById('pagination-controls'),
				area: document.getElementById('content-area'),
			}

			const themes = {
				white: { bg: '#ffffff', text: '#000000', outer: '#e0e0e0' },
				dark: { bg: '#1a1a1a', text: '#d1d1d1', outer: '#1a1a1a' },
				sepia: { bg: '#f4ecd8', text: '#2b2b2b', outer: '#f4ecd8' },
			}

			// --- Core Logic ---

			function toggleToolbar() {
				els.toolbar.classList.toggle('hidden')
			}

			function applySettings() {
				const root = document.documentElement
				let currentColors

				// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç–∞
				if (settings.theme === 'custom') {
					currentColors = {
						bg: settings.customBg,
						text: settings.customText,
						outer: settings.customBg, // –î–ª—è –∫–∞—Å—Ç–æ–º–∞ –¥–µ–ª–∞–µ–º outer —Ç–∞–∫–∏–º –∂–µ –∫–∞–∫ bg –¥–ª—è –ø–æ–≥—Ä—É–∂–µ–Ω–∏—è
					}
				} else {
					currentColors = themes[settings.theme]
				}

				// –ü—Ä–∏–º–µ–Ω—è–µ–º CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
				root.style.setProperty('--bg-color', currentColors.bg)
				root.style.setProperty('--text-color', currentColors.text)
				root.style.setProperty('--outer-bg', currentColors.outer)

				root.style.setProperty('--font-family', settings.fontFamily)
				root.style.setProperty('--font-size', settings.fontSize + 'px')
				root.style.setProperty('--line-height', settings.lineHeight)

				// –®–∏—Ä–∏–Ω–∞
				if (settings.widthPercent >= 98) {
					root.style.setProperty('--content-width', '100%')
					els.wrapper.style.boxShadow = 'none'
					els.widthValDisplay.innerText = '100%'
				} else {
					// –ü—Ä–∏–º–µ—Ä–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è % –≤ px –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ %
					root.style.setProperty('--content-width', settings.widthPercent + '%')
					els.wrapper.style.boxShadow = '0 0 20px rgba(0,0,0,0.15)'
					els.widthValDisplay.innerText = settings.widthPercent + '%'
				}

				// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è UI (–∏–Ω–ø—É—Ç—ã)
				els.fontSelect.value = settings.fontFamily
				els.sizeInput.value = settings.fontSize
				els.widthSlider.value = settings.widthPercent
				els.lhInput.value = settings.lineHeight

				// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–∏–∫–µ—Ä–æ–≤ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ç–µ–º–∞, –ø–∏–∫–µ—Ä—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ–¥ –Ω–µ—ë)
				els.bgPicker.value = currentColors.bg
				els.textPicker.value = currentColors.text

				// updatePdfFilter() // –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –¥–ª—è PDF –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

				// --- –ù–û–í–´–ô –ë–õ–û–ö: –ú–∞–≥–∏—è –ø–µ—Ä–µ–∫—Ä–∞—Å–∫–∏ PDF ---

				// 1. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ü–≤–µ—Ç–∞ (Bg –∏ Text) –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏
				// (–∏–ª–∏ –±–µ—Ä–µ–º –Ω–∞–ø—Ä—è–º—É—é –∏–∑ currentColors)
				const bgHex = currentColors.bg
				const textHex = currentColors.text

				// 2. –§—É–Ω–∫—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ HEX (#ffffff) –≤ —á–∏—Å–ª–æ (0...1)
				const hexToNorm = h => [
					parseInt(h.substr(1, 2), 16) / 255, // R
					parseInt(h.substr(3, 2), 16) / 255, // G
					parseInt(h.substr(5, 2), 16) / 255, // B
				]

				const bgRGB = hexToNorm(bgHex) // –ù–∞–ø—Ä–∏–º–µ—Ä [1, 1, 1] –¥–ª—è –±–µ–ª–æ–≥–æ
				const textRGB = hexToNorm(textHex) // –ù–∞–ø—Ä–∏–º–µ—Ä [0, 0, 0] –¥–ª—è —á–µ—Ä–Ω–æ–≥–æ

				// 3. –û–±–Ω–æ–≤–ª—è–µ–º SVG —Ñ–∏–ª—å—Ç—Ä
				// tableValues="–¢–µ–∫—Å—Ç –§–æ–Ω" (–∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è 0 –∏ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è 1)
				document
					.getElementById('func-r')
					.setAttribute('tableValues', `${textRGB[0]} ${bgRGB[0]}`)
				document
					.getElementById('func-g')
					.setAttribute('tableValues', `${textRGB[1]} ${bgRGB[1]}`)
				document
					.getElementById('func-b')
					.setAttribute('tableValues', `${textRGB[2]} ${bgRGB[2]}`)

				// 4. –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ç–æ—Ç —Ñ–∏–ª—å—Ç—Ä –∫ Canvas PDF
				// –ï—Å–ª–∏ —Ç–µ–º–∞ –±–µ–ª–∞—è (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è), —Ñ–∏–ª—å—Ç—Ä –Ω–µ –Ω—É–∂–µ–Ω (–¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
				const canvases = document.querySelectorAll('canvas.pdf-page')
				const isDefault =
					settings.theme === 'white' && settings.customBg === '#ffffff'

				canvases.forEach(c => {
					// –ï—Å–ª–∏ —Ç–µ–º–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è - —É–±–∏—Ä–∞–µ–º —Ñ–∏–ª—å—Ç—Ä, –∏–Ω–∞—á–µ - —Å—Ç–∞–≤–∏–º –Ω–∞—à ID
					c.style.filter = isDefault ? 'none' : 'url(#recolor-filter)'
				})

				saveToStorage()
			}

			function setTheme(name) {
				settings.theme = name
				// –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ –ø—Ä–µ—Å–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ü–≤–µ—Ç–∞,
				// —á—Ç–æ–±—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø–∏–∫–µ—Ä–æ–≤ —Å—Ç–∞—Ä—Ç –±—ã–ª —Å —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞
				if (name !== 'custom') {
					settings.customBg = themes[name].bg
					settings.customText = themes[name].text
				}
				applySettings()
			}

			// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
			els.fontSelect.addEventListener('change', e => {
				settings.fontFamily = e.target.value
				applySettings()
			})
			els.sizeInput.addEventListener('input', e => {
				settings.fontSize = e.target.value
				applySettings()
			})
			els.lhInput.addEventListener('input', e => {
				settings.lineHeight = e.target.value
				applySettings()
			})

			// –°–ª–∞–π–¥–µ—Ä —à–∏—Ä–∏–Ω—ã
			els.widthSlider.addEventListener('input', e => {
				settings.widthPercent = e.target.value
				applySettings()
			})

			// –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ü–≤–µ—Ç–∞
			function handleCustomColor() {
				settings.theme = 'custom'
				settings.customBg = els.bgPicker.value
				settings.customText = els.textPicker.value
				applySettings()
			}
			els.bgPicker.addEventListener('input', handleCustomColor)
			els.textPicker.addEventListener('input', handleCustomColor)

			// --- Storage & Sharing ---

			function saveToStorage() {
				localStorage.setItem('superReaderSettings', JSON.stringify(settings))
			}

			function loadSettings() {
				const params = new URLSearchParams(window.location.search)

				// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –°—Å—ã–ª–∫–∞
				if (params.has('theme')) {
					settings.theme = params.get('theme')
					settings.fontSize = params.get('fs') || 18
					settings.fontFamily = params.get('ff') || "'Times New Roman', serif"
					settings.widthPercent = params.get('w') || 60

					// –ï—Å–ª–∏ –≤ —Å—Å—ã–ª–∫–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ü–≤–µ—Ç–∞
					if (params.has('cbg')) settings.customBg = params.get('cbg')
					if (params.has('ctxt')) settings.customText = params.get('ctxt')

					window.history.replaceState(
						{},
						document.title,
						window.location.pathname
					)
				}
				// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: LocalStorage
				else {
					const saved = localStorage.getItem('superReaderSettings')
					if (saved) Object.assign(settings, JSON.parse(saved))
				}
				applySettings()
			}

			function shareSettings() {
				const url = new URL(window.location)
				url.searchParams.set('theme', settings.theme)
				url.searchParams.set('fs', settings.fontSize)
				url.searchParams.set('ff', settings.fontFamily)
				url.searchParams.set('w', settings.widthPercent)

				if (settings.theme === 'custom') {
					url.searchParams.set('cbg', settings.customBg)
					url.searchParams.set('ctxt', settings.customText)
				}

				navigator.clipboard.writeText(url.toString()).then(() => {
					const btn = document.querySelector('.action-btn')
					const oldText = btn.innerText
					btn.innerText = 'Copied!'
					setTimeout(() => (btn.innerText = oldText), 2000)
				})
			}

			// --- File Rendering (–ö—Ä–∞—Ç–∫–æ, –∫–∞–∫ –±—ã–ª–æ) ---

			let pdfDoc = null
			let pdfPageNum = 1
			const PAGES_PER_VIEW = 5

			els.fileInput.addEventListener('change', async e => {
				const file = e.target.files[0]
				if (!file) return
				els.pagination.style.display = 'none'
				els.area.innerHTML = '<p style="text-align:center">–ó–∞–≥—Ä—É–∑–∫–∞...</p>'
				if (file.type === 'text/plain') renderTxt(file)
				else if (file.type === 'application/pdf') renderPdf(file)
				else if (file.name.endsWith('.docx')) renderDocx(file)
			})

			function renderTxt(file) {
				const reader = new FileReader()
				reader.onload = e => {
					els.area.innerHTML = e.target.result
						.split(/\n\s*\n/)
						.map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`)
						.join('')
				}
				reader.readAsText(file)
			}

			function renderDocx(file) {
				const reader = new FileReader()
				reader.onload = e => {
					mammoth
						.convertToHtml({ arrayBuffer: e.target.result })
						.then(res => (els.area.innerHTML = res.value))
						.catch(err => (els.area.innerHTML = 'Error loading DOCX'))
				}
				reader.readAsArrayBuffer(file)
			}

			async function renderPdf(file) {
				const arrayBuffer = await file.arrayBuffer()
				pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise
				pdfPageNum = 1
				els.pagination.style.display = 'flex'
				renderPdfPages()
			}

			async function renderPdfPages() {
				els.area.innerHTML = ''
				const endPage = Math.min(
					pdfPageNum + PAGES_PER_VIEW - 1,
					pdfDoc.numPages
				)
				document.getElementById(
					'page-info'
				).innerText = `${pdfPageNum}-${endPage} / ${pdfDoc.numPages}`

				for (let i = pdfPageNum; i <= endPage; i++) {
					const page = await pdfDoc.getPage(i)
					const viewport = page.getViewport({ scale: 1.5 })
					const canvas = document.createElement('canvas')
					canvas.className = 'pdf-page'
					const ctx = canvas.getContext('2d')
					canvas.height = viewport.height
					canvas.width = viewport.width
					await page.render({ canvasContext: ctx, viewport: viewport }).promise
					els.area.appendChild(canvas)
				}
				// updatePdfFilter()
				document.getElementById('reader-container').scrollTop = 0
				applySettings()
			}

			// –§–∏–ª—å—Ç—Ä –¥–ª—è PDF (–∏–Ω–≤–µ—Ä—Å–∏—è —Ü–≤–µ—Ç–æ–≤)
			// function updatePdfFilter() {
			// 	const canvases = document.querySelectorAll('canvas.pdf-page')
			// 	canvases.forEach(c => {
			// 		c.style.filter = 'none'
			// 		// –õ–æ–≥–∏–∫–∞ –∏–Ω–≤–µ—Ä—Å–∏–∏: –µ—Å–ª–∏ —Ñ–æ–Ω –æ—á–µ–Ω—å —Ç–µ–º–Ω—ã–π, –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º PDF
			// 		if (
			// 			isDarkColor(
			// 				settings.theme === 'custom'
			// 					? settings.customBg
			// 					: themes[settings.theme].bg
			// 			)
			// 		) {
			// 			c.style.filter = 'invert(1) hue-rotate(180deg)'
			// 		}
			// 		if (settings.theme === 'sepia') {
			// 			c.style.filter = 'sepia(0.5)'
			// 		}
			// 	})
			// }

			// –ü—Ä–æ–≤–µ—Ä–∫–∞ "—Ç–µ–º–Ω–æ—Å—Ç–∏" —Ü–≤–µ—Ç–∞ (—Ö–µ–ª–ø–µ—Ä)
			function isDarkColor(hex) {
				const r = parseInt(hex.substr(1, 2), 16)
				const g = parseInt(hex.substr(3, 2), 16)
				const b = parseInt(hex.substr(5, 2), 16)
				// –§–æ—Ä–º—É–ª–∞ —è—Ä–∫–æ—Å—Ç–∏
				return (r * 299 + g * 587 + b * 114) / 1000 < 128
			}

			document.getElementById('prev-page').addEventListener('click', () => {
				if (pdfPageNum <= 1) return
				pdfPageNum -= PAGES_PER_VIEW
				renderPdfPages()
			})
			document.getElementById('next-page').addEventListener('click', () => {
				if (pdfPageNum + PAGES_PER_VIEW > pdfDoc.numPages) return
				pdfPageNum += PAGES_PER_VIEW
				renderPdfPages()
			})

			// Init
			loadSettings()
		</script>
	</body>
</html>
